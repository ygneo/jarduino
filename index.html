<!DOCTYPE html>


<script>
var fs = require('fs');
var childProcess =  require("child_process");
var pythonShell = require('python-shell');
var running_pyshell = null;


function soilMoistureValues() {
    return "{" + document.getElementById("watering1_moisture").value + "," + document.getElementById("watering2_moisture").value + "}";
}


function jarduinoUpload() {
    var pyshell = new pythonShell('jarduino.py', {"args": ["upload"]});

    pyshell.on('message', function (message) {
        // received a message sent from the Python script (a simple "print" statement)
        console.log(message);
    });

    // end the input stream and allow the process to exit
    pyshell.end(function (err) {
        if (err){
            console.log(err);
        };
        console.log('finished');
        runnig_pyshell = createJarduinoPyShell();
    });
}

function update() {
    var codeConfig = {
        "soilMoistureMinSensorValues": soilMoistureValues(),
        "checkingDelay": 1000,
        "numchecksBeforeWatering": 3,
        "wateringTime": [200, 300]
    }
    var json = JSON.stringify(codeConfig);
    fs.writeFile('sketches/jarduino/jarduino.json', json, 'utf8');

    running_pyshell.childProcess.kill();

    setTimeout(jarduinoUpload, 3000);

}

function createJarduinoReadInputPyShell(fake_input) {
    if (fake_input == undefined) {
        fake_input = false;
    }
    var args = ["read"];

    if (fake_input) {
        args = ["readfake"];
    }

    var pyshell = new pythonShell('jarduino.py', {"args": args, "mode": "json"});

    pyshell.on('message', function (message) {
        // received a message sent from the Python script (a simple "print" statement)
        console.log(message);
    });

    // end the input stream and allow the process to exit
    pyshell.end(function (err) {
        if (err){
            alert(err);
        };
        console.log('finished');
    });

    return pyshell;
}

function readSerialInput(fakeSerialInput) {
    running_pyshell = createJarduinoReadInputPyShell(fakeSerialInput);
}

readSerialInput();

</script>



<html>
  <head>
    <title>Jarduino</title>
  </head>
    <body>
    <h2>Zona de riego 1</h2>
    <input id="watering1_moisture" type="text" value="200"></input>
    <h2>Zona de riego 2</h2>
    <input id="watering2_moisture" type="text" value="200"></input>
    <hr/>
    <input type="button" value="Actualizar" onclick="update();"></input>
    <hr/>
    <label for="fake_serial">Fake Serial Input</label><input type="checkbox" id="fake_serial" onclick="readSerialInput(true)"/> 
    </body>
 
</html>
